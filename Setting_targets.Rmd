---
title: 'Setting targets in global health: Case study'
---

This markdown file describes the analysis plan for the secondary target setting paper.  
The paper will essentially show how target setting can be done using league tables of viable interventions, with a country's cost per YLD averted. This will prioritise an intervention to be done first up to the maximum viable coverage, then remove it from the list and repeat the league table exercise until all interventions are applied, costs are too high, or cost-effectiveness is not achievable.  

The visualisation plan is for league tables by region, with regions as facets on the Y-axis (vertical), and cost/DALY on the X-axis (horizontal) with a dashed line for each facet denoting the regional WTP and a density plot for each distribution of cost/YLD by simulation.

```{r, message = FALSE, warning = FALSE}
gc()
options(scipen = 999, digits = 5)

library(tidyverse)
library(vroom)
library(countrycode)
library(EnvStats)
library(zoo)

source("./99_Functions.R")

# Read in 2030 population estimates
df_2030 <- readRDS("./Data/est_2030.rds")

# Get full country list
countrylist <- unique(df_2030$location_name)

# Assuming 10,000 iterations
iter <- 10000

# And a WTP threshold of $10000 (just chose a random number)
WTP <- 10000

# Read in costs, interventions, coverage and filter by country
source("./1_Interventions.R")

# Maximum possible coverage is 100% in this example
coverage_max <- 1

# YLDs saved:
YLD_mild <- 0.005
YLD_moderate <- 0.053
YLD_severe <- 0.150
```

There are 6 interventions we will consider in this list:  
```{r}
# List of interventions
interventions <- c(
  "DailyIron_Preg", # Daily iron and folic acid supplementation in pregnant women
  "DailyIron_WRA", # Daily iron supplementation in WRA
  "Staple", # Staple food supplementation in all individuals
  "IntIron_Preg", # Intermittent iron and folic acid supplementation in pregnant women
  "IntIron_WRA", # Intermittent iron supplementation in WRA
  "Antimalarial" # Antenatal intermittent antimalarials
)
```

The basic structure of the league table idea is as follows:  
- Obtain the cost of each intervention per person and multiply by the increase in eligible population (e.g., pregnant women not currently receiving the intervention)  
- Obtain the effectiveness (RR) of each intervention, enter that into the following formula with given current and maximum coverage:  
$$
\theta = \frac{1 - c_{max}(1 - RR_1)}{1 - c_{current}(1 - RR_0)}
$$
- Now multiply theta by the target population (e.g. pregnant anaemic women) of each type of anaemia: mild, moderate, and severe, and obtain the YLD for each type
- Divide costs by YLD and sort ascending  
- Pick the top option and then remove that intervention from the list  
- Repeat

```{r}
# First 131 countries works - just do top 10 for now to make code work
countrylist <- countrylist[c(1:10)]
```


```{r, warning = FALSE}
# Run the simulator function for each intervention:
# Simulator takes prevalence data, country, intervention name, eligible population (for costs) and targeted population (for effects)

# Run analysis for each country
stage0 <- list()
for (i in 1:length(countrylist)) {
  country <- countrylist[i]

  sims <- list(
    # Daily iron + FA in pregnant women
    simulator(df_2030, country, interventions[[1]], "Pop_pregnant", "Pop_pregnant_anaemic"),
    # Daily Iron in WRA
    simulator(df_2030, country, interventions[[2]], "Pop_wra", "Pop_anaemic"),
    # Staple food supplementation for all
    simulator(df_2030, country, interventions[[3]], "Pop_total", "Pop_anaemic"),
    # Intermittent iron + FA for pregnant women
    simulator(df_2030, country, interventions[[4]], "Pop_pregnant", "Pop_pregnant_anaemic"),
    # Intermittent iron in WRA
    simulator(df_2030, country, interventions[[5]], "Pop_wra", "Pop_anaemic"),
    # Antimalarials in pregnant women
    simulator(df_2030, country, interventions[[6]], "Pop_pregnant", "Pop_pregnant_malaria_anaemic")
  )

  stage0[[i]] <- do.call(rbind, sims) |>
    group_by(Intervention) |>
    summarise(Cost_per_YLD = mean(Cost_per_YLD)) |>
    mutate(Country = country) |>
    relocate(Country, .before = Intervention) |>
    arrange(Cost_per_YLD)

  paste0(country, " done")
}

cea_0 <- do.call(rbind, stage0)
remove(stage0, sims)
```

This demonstrates which intervention is the most cost-effective for a given country. Now we can extract the top row for each country and feed this intervention into a loop over every country.

```{r}
# Identify intervention 1
int1 <- cea_0 |>
  group_by(Country) |>
  slice(1) |>
  pull(2)

# Apply intervention 1 to each country
stage1 <- list()
for (i in 1:length(countrylist)) {
  # For each country, obtain the first intervention in the list by cost-effectiveness (int1)
  # Apply the intervention using the formula above

  df_post1 <- df_2030 |>
    filter(location_name == countrylist[i]) |>
    mutate(
      Pop_pregnant_anaemic_1 =
        Pop_pregnant_anaemic *
          (1 - coverage_max * (1 - mean(intervention_list[[int1[i]]]))) /
          (1 - df_coverage[[int1[i]]][df_coverage$location_name == countrylist[i]] * (1 - mean(intervention_list[[int1[i]]]))),
      Pop_anaemic_1 =
        ifelse(int1[i] %in% c("DailyIron_Preg", "IntIron_Preg", "Antimalarial"),
          Pop_anaemic,
          Pop_anaemic *
            (1 - coverage_max * (1 - mean(intervention_list[[int1[i]]]))) /
            (1 - df_coverage[[int1[i]]][df_coverage$location_name == countrylist[i]] * (1 - mean(intervention_list[[int1[i]]])))
        )
    ) |>
    mutate(
      YLD1 =
        case_when(
          rei_name == "Mild anemia" ~ (Pop_anaemic_1 + Pop_pregnant_anaemic_1) * 0.005,
          rei_name == "Moderate anemia" ~ (Pop_anaemic_1 + Pop_pregnant_anaemic_1) * 0.053,
          rei_name == "Severe anemia" ~ (Pop_anaemic_1 + Pop_pregnant_anaemic_1) * 0.150
        )
    )
  print(countrylist[i])
}


```

After which we can simply repeat the simulator without staple foods on the new data:
```{r, warning = FALSE}
# Call in functions
# Run the simulator function for each intervention
sims <- list(
  simulator(df_post1, country, interventions[[1]], "Pop_pregnant", "Pop_pregnant_anaemic"), # Daily iron + FA in pregnant women
  simulator(df_post1, country, interventions[[2]], "Pop_wra", "Pop_anaemic"), # Daily Iron in WRA
  simulator(df_post1, country, interventions[[5]], "Pop_wra", "Pop_anaemic") # Intermittent iron in WRA
)

stage2 <- do.call(rbind, sims) |>
  group_by(Intervention) |>
  summarise(Cost_per_YLD = mean(Cost_per_YLD)) |>
  arrange(Cost_per_YLD)
stage2
```

