---
title: 'Setting targets in anaemia'
editor_options: 
  chunk_output_type: console
---

This markdown file walks through the analysis for the target setting paper.  
The paper will essentially show how target setting can be done using league tables of viable interventions, with a country's cost per YLD averted and WTP threshold set as the decision rule for implementing interventions sequentially. This will prioritise an intervention to be done first up to the maximum viable coverage, then remove it from the list and repeat the league table exercise until all cost-effective interventions are applied.

This file takes the input data (prevalence, costs, and coverage) and repeatedly draws from these as distributions. It will repeat the simulation n times, with a different estimate for cost and effectiveness each time. This ensures that there isn't a 'fanning' effect where the low or high quantile is taken every time, leading to increasingly wider intervals as every intervention is done.

This should be submitted to IHEA 2025 and will form the basis of our recommendation for section 6 of the Lancet commission.

```{r, warning = FALSE, message = FALSE}
options(scipen = 999, digits = 5)

library(countrycode)
library(EnvStats)
library(tidyverse)
library(scales)
library(foreach)
library(doParallel)

# Load helper functions
source("./99_Functions.R")

# Read in 2030 population estimates, costs, and coverage
df_prevalence <- readRDS("./Data/est_2030.rds")
df_costs_base <- readRDS("./Data/costs.rds")
df_coverage <- readRDS("./Data/coverage.rds")

# Using 1 iteration per draw
iter <- 1

# Filter by countries with data for all three input data frames
df_prevalence <- df_prevalence |>
  filter(location_name %in% Reduce(intersect, list(
    df_prevalence$location_name,
    df_costs_base$location_name,
    df_coverage$location_name
  )))

# Get full country list
countrylist <- unique(df_prevalence$location_name)

# Which WTP threshold to use?
# NB: "Opp_Upper" corresponds to Pichon-Riviere opportunity cost method (base case)
WTP_list <- c("Opp_Lower", "Opp_Upper", "HCFI_Lower", "HCFI_Upper")
Threshold <- WTP_list[2]

WTP <- df_costs_base |>
  select(
    location_name,
    paste0("WTP_", Threshold)
  ) |>
  rename(
    Country = location_name,
    WTP = paste0("WTP_", Threshold)
  )
```

There are 4 interventions we will consider in this list.  However, the iron supplementation program will be modified depending on the baseline prevalence of anaemia in the population, which affects whether it will be implemented daily or intermittently.
```{r}
# List of interventions:
interventions <- c(
  "Iron_Preg", # Iron and folic acid supplementation in pregnant women
  "Iron_WRA", # Iron supplementation in WRA
  "Fortification", # Staple food supplementation in all individuals
  "Antimalarial" # Antenatal intermittent antimalarials
)
```

The basic structure of the league table idea is as follows:  
- Obtain the cost of each intervention per person and multiply by the increase in eligible population (e.g., pregnant women not currently receiving the intervention)  
- Obtain the effectiveness (RR) of each intervention, enter that into the following formula with given current and maximum coverage:  
$$
\theta = \frac{1 - c_{max}(1 - RR)}{1 - c_{current}(1 - RR)}
$$
- Now multiply theta by the target population (e.g. pregnant anaemic women) of each type of anaemia: mild, moderate, and severe, and obtain the YLD for each type
- Divide costs by YLD and sort ascending  
- Pick the top option and then remove that intervention from the list  
- Repeat

```{r}
# Set number of iterations
n <- 200

# Prepare parallel computing
cores <- detectCores()
cl <- makeCluster(cores - 2)
registerDoParallel(cl)

# Create output list
final_reduction <- list()

# Repeat model n times
set.seed(888)
final_reduction <- foreach(j = 1:n, .export = ls(), .packages = c("tidyverse", "EnvStats")) %dopar% {
  source("1_Run_model.R", local = T)

  final_reduction[[j]] <- df_final |>
    rename(
      Pop_pregnant_anaemic_post = Pop_pregnant_anaemic,
      Pop_pregnant_malaria_anaemic_post = Pop_pregnant_malaria_anaemic,
      Pop_anaemic_post = Pop_anaemic,
      YLD_post = YLD
    ) |>
    full_join(df_2030,
      by = join_by(location_name, rei_name, Anaemia_rate, Pop_wra, Pop_total, Pop_pregnant)
    ) |>
    mutate(
      Change_anaemic = Pop_anaemic_post - Pop_anaemic,
      Pct_change_anaemic = Change_anaemic / Pop_anaemic
    ) |>
    rename(
      Country = location_name,
      Anaemia_severity = rei_name,
      Pop_pregnant_anaemic_pre = Pop_pregnant_anaemic,
      Pop_pregnant_malaria_anaemic_pre = Pop_pregnant_malaria_anaemic,
      Pop_anaemic_pre = Pop_anaemic,
      YLD_pre = YLD
    ) |>
    group_by(Country) |>
    summarise(
      anaemic_pre = sum(Pop_anaemic_pre),
      anaemic_post = sum(Pop_anaemic_post),
      YLD_pre = sum(YLD_pre),
      YLD_post = sum(YLD_post)
    ) |>
    mutate(
      Pct_change_anaemic = (anaemic_pre - anaemic_post) / anaemic_pre,
      DALYs_averted = YLD_post - YLD_pre,
      Pct_change_YLD = (YLD_pre - YLD_post) / YLD_pre,
      Iteration = j
    )
}

results <- do.call(rbind, final_reduction)

change <- results |>
  group_by(Country) |>
  summarise(
    change_median = median(Pct_change_anaemic),
    change_low = quantile(Pct_change_anaemic, 0.025),
    change_high = quantile(Pct_change_anaemic, 0.975),
    DALYs_prevented_median = median(DALYs_averted),
    DALYs_prevented_low = quantile(DALYs_averted, 0.975),
    DALYs_prevented_high = quantile(DALYs_averted, 0.025)
  )


save(change, results, final_reduction, file = "sim_results.RData")
write_csv(change, file = "simulation_results.csv")
```

The visualisation plan is for league tables by region, with regions as facets on the Y-axis (vertical), and cost/DALY on the X-axis (horizontal) with a dashed line for each facet denoting the regional WTP and a density plot for each distribution of cost/YLD by simulation.

```{r}
load("sim_results.RData")

# Results
c(Mean = mean(change$change_median), Low = mean(change$change_low), High = mean(change$change_high))

# Data viz
country_details <- df_coverage |>
  rename(
    Income_group = `Income group`,
    Country = location_name
  ) |>
  select(Country, Region, Income_group)

p <- change |>
  left_join(country_details, by = join_by(Country)) |>
  ggplot()
remove(country_details)

p +
  geom_density(aes(x = change, fill = Income_group), alpha = 0.5) +
  # facet_wrap(vars(Region), scales = "free_y") +
  theme_bw() +
  labs(
    x = "Maximum feasible reduction in anaemia prevalence (%)",
    y = "Frequency"
  )
```



